<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pencatatan Piutang</title>
    <style>
        /* --- Gaya Umum --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #eef2f7;
            color: var(--dark-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        h1, h2 {
            color: var(--dark-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Gaya Form --- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
            padding: 5px 10px;
            font-size: 14px;
        }

        .btn:active {
            transform: scale(0.98);
        }
        
        .notification {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }
        
        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* --- Gaya Tabel --- */
        .table-container {
            overflow-x: auto;
            margin-top: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        thead th {
            background-color: var(--light-color);
            font-weight: 700;
            color: var(--dark-color);
        }

        tbody tr:hover {
            background-color: #f1f3f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        /* --- Gaya Total --- */
        .total-section {
            margin-top: 20px;
            text-align: right;
            font-size: 1.2em;
            font-weight: bold;
        }

        .total-amount {
            color: var(--success-color);
        }

        /* --- Gaya Rekap per Pelanggan --- */
        #rekap-section {
            margin-top: 40px;
        }

        .rekap-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }

        .rekap-card-header {
            background-color: var(--light-color);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .rekap-card-header:hover {
            background-color: #e9ecef;
        }

        .rekap-card-header h3 {
            margin: 0;
            font-size: 1.1em;
            color: var(--dark-color);
        }

        .rekap-card-header .total-amount {
            font-size: 1.1em;
            margin: 0;
        }

        .rekap-card-header::after {
            content: 'â–¶';
            font-size: 0.8em;
            color: var(--secondary-color);
            transition: transform 0.3s ease;
        }

        .rekap-card.active .rekap-card-header::after {
            transform: rotate(90deg);
        }

        .rekap-card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background-color: #fff;
        }
        
        .rekap-card.active .rekap-card-body {
            max-height: 500px;
            overflow-y: auto;
        }

        .rekap-card-body .table-container {
            margin-top: 0;
            padding: 15px;
        }

        .rekap-card-body table {
            font-size: 0.9em;
        }
        
        .rekap-card-body th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        #emptyRekapMessage {
            text-align: center;
            color: #999;
            padding: 20px;
            border: 1px dashed var(--border-color);
            border-radius: 4px;
        }
        
        /* --- Gaya Ringkasan Total --- */
        #rekap-summary-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        #rekap-summary-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: var(--dark-color);
        }

        #rekap-summary-section .table-container {
            margin-top: 0;
        }

        #rekap-summary-section table {
            font-size: 1em;
        }

        #rekap-summary-section .grand-total-row {
            background-color: #e9ecef;
            font-weight: bold;
        }

        #rekap-summary-section .grand-total-row td {
            color: var(--dark-color);
        }
        
        /* --- Gaya Footer (BARU) --- */
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            font-size: 0.9em;
            color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
        }
        
        /* --- Utility Class --- */
        .text-center {
            text-align: center;
        }
        
        /* --- Gaya Khusus untuk Cetak (Print) - DIPERBAIKI --- */
        @media print {
            @page {
                size: A4;
                margin: 1.5cm;
            }

            body {
                background-color: #fff;
                padding: 0;
                font-size: 12px; /* Ukuran font lebih kecil untuk menghemat kertas */
            }
            .container {
                box-shadow: none;
                padding: 0;
                max-width: 100%;
            }
            header, #form-section, #table-section, .notification, .no-print, footer {
                display: none !important;
            }

            #rekap-section {
                display: block !important;
            }
            
            /* Hapus judul rekapitulasi (BARU) */
            #rekap-section h2 {
                display: none !important;
            }

            /* Sederhanakan kartu rekap (BARU) */
            .rekap-card {
                border: none !important;
                box-shadow: none !important;
                margin-bottom: 20px;
                page-break-inside: avoid; /* Cegah kartu terpotong */
            }
            .rekap-card-header {
                background-color: transparent !important;
                cursor: default;
                padding: 0 0 10px 0 !important;
                border-bottom: 1px solid #000 !important;
            }
            .rekap-card-header::after {
                display: none;
            }
            .rekap-card-body {
                max-height: none !important;
                overflow: visible !important;
                padding: 10px 0 0 0 !important;
            }

            /* Sederhanakan tabel (BARU) */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                color: #000 !important;
                padding: 8px 10px !important; /* Padding lebih kecil */
                border: 1px solid #000 !important; /* Border hitam yang jelas */
                background-color: transparent !important;
            }
            thead th {
                font-weight: bold;
                text-align: center;
            }
            tbody tr:hover {
                background-color: transparent !important;
            }
            .grand-total-row {
                background-color: transparent !important;
            }
            .grand-total-row td {
                font-weight: bold;
            }

            #rekap-summary-section {
                display: block !important;
                page-break-inside: avoid;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px solid #000;
            }
            
            h1, h2, h3 {
                page-break-after: avoid;
                border: none;
            }
            
            /* Gaya Header Khusus Cetak */
            .print-header {
                display: block !important;
                text-align: center !important;
                font-size: 20px !important;
                font-weight: bold !important;
                margin-bottom: 30px !important;
                color: #000 !important;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .rekap-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            h2 {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>

    <!-- Header Khusus untuk Cetak -->
    <h1 class="print-header">REKAP PIUTANG KONSUMEN RURA SEJAHTERA GRUP</h1>

    <div class="container">
        <header>
            <h1>Sistem Pencatatan Piutang</h1>
        </header>

        <main>
            <!-- Notifikasi -->
            <div id="notification" class="notification"></div>

            <!-- Form Transaksi -->
            <section id="form-section">
                <h2>Form Transaksi Baru</h2>
                <form id="piutangForm">
                    <input type="hidden" id="editId" value="">
                    
                    <div class="form-group">
                        <label for="namaKonsumen">Nama Konsumen</label>
                        <input type="text" id="namaKonsumen" placeholder="Masukkan nama konsumen" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="divisi">Divisi</label>
                            <select id="divisi" required>
                                <option value="">-- Pilih Divisi --</option>
                                <option value="RMM">RMM</option>
                                <option value="BSL">BSL</option>
                                <option value="RP">RP</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="jumlahNota">Jumlah Nota/Invoice</label>
                            <input type="number" id="jumlahNota" placeholder="Contoh: 5" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="jumlahPiutang">Jumlah Piutang (Rp)</label>
                        <input type="number" id="jumlahPiutang" placeholder="Contoh: 1500000" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="keterangan">Keterangan</label>
                        <textarea id="keterangan" placeholder="Tambahkan keterangan jika diperlukan..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">Simpan Transaksi</button>
                </form>
            </section>

            <!-- Tabel Data Piutang -->
            <section id="table-section">
                <h2>Daftar Semua Transaksi</h2>
                <div class="table-container">
                    <table id="piutangTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Nama Konsumen</th>
                                <th>Divisi</th>
                                <th>Jumlah Nota</th>
                                <th>Jumlah Piutang</th>
                                <th>Keterangan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="piutangTableBody">
                            <!-- Data akan dimuat di sini oleh JavaScript -->
                        </tbody>
                    </table>
                    <p id="emptyMessage" style="text-align: center; color: #999; margin-top: 20px;">Belum ada data piutang.</p>
                </div>
                <div class="total-section">
                    Total Seluruh Piutang: <span class="total-amount" id="totalPiutang">Rp 0</span>
                </div>
            </section>

            <!-- Rekapitulasi per Pelanggan -->
            <section id="rekap-section">
                <h2>
                    Rekapitulasi Piutang per Pelanggan
                    <button class="btn btn-success no-print" onclick="cetakRekap()">
                        Cetak Rekapitulasi (PDF)
                    </button>
                </h2>
                <div id="rekapContainer">
                    <!-- Data rekap akan dimuat di sini oleh JavaScript -->
                </div>
                <p id="emptyRekapMessage" style="display: none; text-align: center; color: #999;">Belum ada data untuk direkap.</p>
                
                <!-- Ringkasan Total per Divisi -->
                <div id="rekap-summary-section">
                    <!-- Konten ringkasan akan dimuat di sini oleh JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <!-- Footer (BARU) -->
    <footer class="no-print">
        powered by @alyafta.id 2025
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('piutangForm');
            const tableBody = document.getElementById('piutangTableBody');
            const totalPiutangElement = document.getElementById('totalPiutang');
            const notification = document.getElementById('notification');
            const submitBtn = document.getElementById('submitBtn');
            const editIdField = document.getElementById('editId');
            const emptyMessage = document.getElementById('emptyMessage');
            
            // Elemen untuk rekap
            const rekapContainer = document.getElementById('rekapContainer');
            const emptyRekapMessage = document.getElementById('emptyRekapMessage');
            const rekapSummarySection = document.getElementById('rekap-summary-section');

            // Fungsi untuk menampilkan notifikasi
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            // Fungsi untuk memuat data dari localStorage
            function loadData() {
                const data = localStorage.getItem('piutangData');
                return data ? JSON.parse(data) : [];
            }

            // Fungsi untuk menyimpan data ke localStorage
            function saveData(data) {
                localStorage.setItem('piutangData', JSON.stringify(data));
            }

            // Fungsi untuk format angka ke Rupiah
            function formatRupiah(angka) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(angka);
            }

            // Fungsi untuk merender tabel utama
            function renderTable() {
                const piutangList = loadData();
                tableBody.innerHTML = '';
                
                if (piutangList.length === 0) {
                    emptyMessage.style.display = 'block';
                    totalPiutangElement.textContent = 'Rp 0';
                } else {
                    emptyMessage.style.display = 'none';
                    let total = 0;
                    piutangList.forEach((item, index) => {
                        total += item.jumlahPiutang;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${item.tanggal || '-'}</td>
                            <td>${item.namaKonsumen}</td>
                            <td>${item.divisi}</td>
                            <td>${item.jumlahNota}</td>
                            <td>${formatRupiah(item.jumlahPiutang)}</td>
                            <td>${item.keterangan || '-'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-warning" onclick="editData('${item.id}')">Ubah</button>
                                <button class="btn btn-danger" onclick="deleteData('${item.id}')">Hapus</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    totalPiutangElement.textContent = formatRupiah(total);
                }
                
                renderRekap();
            }

            // Fungsi untuk merender rekapitulasi
            function renderRekap() {
                const piutangList = loadData();
                rekapContainer.innerHTML = '';
                rekapSummarySection.innerHTML = '';

                if (piutangList.length === 0) {
                    emptyRekapMessage.style.display = 'block';
                    return;
                }
                
                emptyRekapMessage.style.display = 'none';

                // --- Proses Data Per Pelanggan ---
                const rekapData = {};
                piutangList.forEach(item => {
                    if (!rekapData[item.namaKonsumen]) {
                        rekapData[item.namaKonsumen] = {
                            totalPiutang: 0,
                            transaksi: []
                        };
                    }
                    rekapData[item.namaKonsumen].totalPiutang += item.jumlahPiutang;
                    rekapData[item.namaKonsumen].transaksi.push(item);
                });

                for (const nama in rekapData) {
                    const dataPelanggan = rekapData[nama];
                    
                    let detailRows = '';
                    dataPelanggan.transaksi.forEach(trans => {
                        detailRows += `
                            <tr>
                                <td>${trans.tanggal || '-'}</td>
                                <td>${trans.divisi}</td>
                                <td class="text-center">${trans.jumlahNota}</td>
                                <td>${formatRupiah(trans.jumlahPiutang)}</td>
                                <td>${trans.keterangan || '-'}</td>
                                <td class="action-buttons no-print">
                                    <button class="btn btn-warning" onclick="editData('${trans.id}')">Ubah</button>
                                    <button class="btn btn-danger" onclick="deleteData('${trans.id}')">Hapus</button>
                                </td>
                            </tr>
                        `;
                    });

                    const cardHTML = `
                        <div class="rekap-card">
                            <div class="rekap-card-header">
                                <h3>${nama}</h3>
                                <p class="total-amount">${formatRupiah(dataPelanggan.totalPiutang)}</p>
                            </div>
                            <div class="rekap-card-body">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Tanggal</th>
                                                <th>Divisi</th>
                                                <th class="text-center">Jumlah Nota</th>
                                                <th>Jumlah Piutang</th>
                                                <th>Keterangan</th>
                                                <th class="no-print">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${detailRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    rekapContainer.innerHTML += cardHTML;
                }

                // --- Proses Data Ringkasan per Divisi ---
                const totalPerDivisi = { RMM: 0, BSL: 0, RP: 0 };
                let grandTotal = 0;

                piutangList.forEach(item => {
                    if (totalPerDivisi.hasOwnProperty(item.divisi)) {
                        totalPerDivisi[item.divisi] += item.jumlahPiutang;
                        grandTotal += item.jumlahPiutang;
                    }
                });

                const summaryHTML = `
                    <h3>Ringkasan Total per Divisi</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Divisi</th>
                                    <th>Total Piutang</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>RMM</td>
                                    <td>${formatRupiah(totalPerDivisi.RMM)}</td>
                                </tr>
                                <tr>
                                    <td>BSL</td>
                                    <td>${formatRupiah(totalPerDivisi.BSL)}</td>
                                </tr>
                                <tr>
                                    <td>RP</td>
                                    <td>${formatRupiah(totalPerDivisi.RP)}</td>
                                </tr>
                                <tr class="grand-total-row">
                                    <td><strong>Total Keseluruhan</strong></td>
                                    <td><strong>${formatRupiah(grandTotal)}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                rekapSummarySection.innerHTML = summaryHTML;


                // Event Listener untuk Akordion
                const headers = document.querySelectorAll('.rekap-card-header');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const card = header.parentElement;
                        document.querySelectorAll('.rekap-card.active').forEach(activeCard => {
                            if (activeCard !== card) {
                                activeCard.classList.remove('active');
                            }
                        });
                        card.classList.toggle('active');
                    });
                });
            }

            // Fungsi untuk menangani submit form
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const editId = editIdField.value;
                const piutangList = loadData();

                const formData = {
                    id: editId || Date.now().toString(),
                    namaKonsumen: document.getElementById('namaKonsumen').value,
                    divisi: document.getElementById('divisi').value,
                    jumlahNota: parseInt(document.getElementById('jumlahNota').value),
                    jumlahPiutang: parseInt(document.getElementById('jumlahPiutang').value),
                    keterangan: document.getElementById('keterangan').value,
                    // Tanggal otomatis: ambil tanggal lama jika edit, buat baru jika transaksi baru
                    tanggal: editId ? piutangList.find(item => item.id === editId).tanggal : new Date().toISOString().split('T')[0]
                };

                if (editId) {
                    const index = piutangList.findIndex(item => item.id === editId);
                    if (index !== -1) {
                        piutangList[index] = formData;
                        showNotification('Data berhasil diperbarui!', 'success');
                    }
                } else {
                    piutangList.push(formData);
                    showNotification('Transaksi berhasil ditambahkan!', 'success');
                }

                saveData(piutangList);
                renderTable();
                form.reset();
                editIdField.value = '';
                submitBtn.textContent = 'Simpan Transaksi';
            });

            // Fungsi untuk menghapus data
            window.deleteData = function(id) {
                if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                    let piutangList = loadData();
                    piutangList = piutangList.filter(item => item.id !== id);
                    saveData(piutangList);
                    renderTable();
                    showNotification('Data berhasil dihapus.', 'success');
                }
            };

            // Fungsi untuk mengedit data
            window.editData = function(id) {
                const piutangList = loadData();
                const dataToEdit = piutangList.find(item => item.id === id);

                if (dataToEdit) {
                    document.getElementById('namaKonsumen').value = dataToEdit.namaKonsumen;
                    document.getElementById('divisi').value = dataToEdit.divisi;
                    document.getElementById('jumlahNota').value = dataToEdit.jumlahNota;
                    document.getElementById('jumlahPiutang').value = dataToEdit.jumlahPiutang;
                    document.getElementById('keterangan').value = dataToEdit.keterangan;
                    
                    editIdField.value = id;
                    submitBtn.textContent = 'Perbarui Transaksi';
                    
                    document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
                }
            };

            // Fungsi untuk mencetak
            window.cetakRekap = function() {
                document.querySelectorAll('.rekap-card').forEach(card => {
                    card.classList.add('active');
                });
                
                setTimeout(() => {
                    window.print();
                }, 300);
            };

            // Initial render
            renderTable();
        });
    </script>
</body>
</html>
